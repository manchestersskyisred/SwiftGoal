<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwiftGoal - AI Sports News</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <style>
        body {
            background-color: #f0f2f5;
        }
        .article-card-hover {
            transition: transform .2s ease-in-out, box-shadow .2s ease-in-out;
        }
        .article-card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
        }
    </style>
</head>
<body>

<div th:fragment="navbar" class="py-3 px-3 mb-3 border-bottom bg-white shadow-sm sticky-top">
    <div class="container-fluid">
        <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
            <a href="/" class="d-flex align-items-center mb-2 mb-lg-0 text-dark text-decoration-none me-4">
                <i class="fas fa-futbol fa-2x"></i>
                <span class="fs-4 ms-2">SwiftGoal</span>
            </a>

            <ul class="nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0">
                <!-- Navigation items can go here if needed -->
            </ul>

            <form class="col-12 col-lg-auto mb-3 mb-lg-0 me-lg-3" th:action="@{/search}">
                <input type="search" name="query" class="form-control" placeholder="搜索新闻..." aria-label="Search" th:value="${searchQuery}">
            </form>

            <div sec:authorize="!isAuthenticated()">
                <a th:href="@{/login}" class="btn btn-outline-primary me-2">登录</a>
                <a th:href="@{/user/register}" class="btn btn-primary">注册</a>
            </div>

            <div sec:authorize="isAuthenticated()" class="dropdown text-end">
                <a href="#" class="d-block link-dark text-decoration-none dropdown-toggle" id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
                    <img th:src="${userAvatarUrl != null ? userAvatarUrl : 'https://github.com/mdo.png'}" alt="mdo" width="40" height="40" class="rounded-circle">
                </a>
                <ul class="dropdown-menu text-small" aria-labelledby="dropdownUser1">
                    <li><a class="dropdown-item" th:href="@{/user/articles}">我的文章</a></li>
                    <li><a class="dropdown-item" th:href="@{/user/{username}(username=${#authentication.name})}">个人资料</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <form th:action="@{/logout}" method="post" class="d-inline">
                            <button type="submit" class="dropdown-item">退出登录</button>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>


<div class="container-fluid">
    <div class="row">
        <div class="col-lg-2">
            <div th:fragment="sidebar" class="d-flex flex-column flex-shrink-0 p-3 bg-light" style="height: calc(100vh - 88px); position: sticky; top: 88px;">
                <ul class="nav nav-pills flex-column">
                    <li class="nav-item">
                        <a href="/" class="nav-link" th:classappend="${currentCategory == 'Home' ? 'active' : ''}" aria-current="page">
                            <i class="fas fa-home me-2"></i> Home
                        </a>
                    </li>
                </ul>
                <hr>
                <div class="sidebar-heading px-3 mt-2 mb-1 text-muted">Categories</div>
                <ul class="nav nav-pills flex-column">
                    <li sec:authorize="isAuthenticated()">
                        <a th:href="@{/recommendations}" class="nav-link link-dark" th:classappend="${currentCategory == '为你推荐' ? 'active' : ''}">
                            <i class="fas fa-star me-2"></i> 为你推荐
                        </a>
                    </li>
                    <li th:each="cat : ${categories}">
                        <a th:href="@{'/category/' + ${cat}}" class="nav-link link-dark" th:classappend="${currentCategory == cat ? 'active' : ''}">
                            <i class="fas fa-futbol me-2"></i> <span th:text="${cat}"></span>
                        </a>
                    </li>
                </ul>
                <hr class="mt-auto">
                <div sec:authorize="isAuthenticated()">
                    <a th:href="@{/user/articles/create}" class="btn btn-primary w-100">
                        <i class="fas fa-pen-to-square me-2"></i> 用户投稿
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-10">
            <main class="container py-4">
                <h2 th:if="${searchQuery}">Search Results for: <span class="text-primary" th:text="${searchQuery}"></span></h2>
                <h2 th:if="${currentCategory}">Category: <span class="text-primary" th:text="${currentCategory}"></span></h2>

                <div id="articles-container" class="row">
                    <!-- Articles will be loaded here by Thymeleaf and JS -->
                    <div th:each="article : ${articlesPage.content}" class="col-lg-12 mb-4">
                        <div class="card h-100 shadow-sm article-card-hover">
                             <div class="card-body">
                                 <h5 class="card-title" th:text="${article.titleCn != null ? article.titleCn : article.title}">Article Title</h5>
                                 <h6 class="card-subtitle mb-2 text-muted" th:text="${article.source} + ' - ' + ${#temporals.format(article.publishDate, 'MMM dd, yyyy HH:mm')}">Source and Date</h6>
                                 <p class="card-text" th:text="${article.summaryAiCn != null ? article.summaryAiCn : article.summaryAi}"></p>
                             </div>
                             <div class="card-footer bg-transparent border-0">
                                  <a th:href="@{/article/{id}(id=${article.id})}" class="btn btn-primary btn-sm">阅读更多</a>
                             </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    let currentPage = 1;
    let totalPages = [[${articlesPage.totalPages}]];
    let isLoading = false;
    const articlesContainer = document.getElementById('articles-container');
    const currentCategory = /*[[${currentCategory}]]*/ 'Home'; // Pass thymeleaf variable to JS

    window.addEventListener('scroll', () => {
        if (isLoading || currentPage >= totalPages) return;

        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
            loadMoreArticles();
        }
    });

    async function loadMoreArticles() {
        isLoading = true;
        showLoadingSpinner();

        // Determine the correct API endpoint
        let apiUrl = '';
        if (currentCategory === 'Home') {
            apiUrl = `/api/news?page=${currentPage}&size=100`;
        } else if (currentCategory === '为你推荐') {
            apiUrl = `/api/news/recommendations?page=${currentPage}&size=100`;
        } else {
            apiUrl = `/api/news/category/${currentCategory}?page=${currentPage}&size=100`;
        }

        try {
            const response = await fetch(apiUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const page = await response.json();
            const articles = page.content;

            if (articles.length > 0) {
                articles.forEach(article => {
                    const articleElement = createArticleCard(article);
                    articlesContainer.appendChild(articleElement);
                });
                currentPage++;
            }

            if (currentPage >= page.totalPages) {
                showEndOfResults();
                totalPages = currentPage; // Prevent further loading
            }
        } catch (error) {
            console.error("Could not load more articles:", error);
            // Optionally show an error message to the user
        } finally {
            isLoading = false;
            hideLoadingSpinner();
        }
    }

    function showLoadingSpinner() {
        let spinner = document.getElementById('loading-spinner');
        if (!spinner) {
            spinner = document.createElement('div');
            spinner.id = 'loading-spinner';
            spinner.className = 'text-center py-4';
            spinner.innerHTML = `
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>`;
            articlesContainer.parentNode.appendChild(spinner);
        }
        spinner.style.display = 'block';
    }

    function hideLoadingSpinner() {
        const spinner = document.getElementById('loading-spinner');
        if (spinner) {
            spinner.style.display = 'none';
        }
    }

    function showEndOfResults() {
         let endMessage = document.getElementById('end-of-results');
         if(!endMessage) {
             endMessage = document.createElement('div');
             endMessage.id = 'end-of-results';
             endMessage.className = 'text-center text-muted py-4';
             endMessage.textContent = 'You have reached the end of the list.';
             articlesContainer.parentNode.appendChild(endMessage);
         }
    }

    function createArticleCard(article) {
        const articleCol = document.createElement('div');
        articleCol.className = 'col-lg-12 mb-4';

        const formattedDate = new Date(article.publishDate).toLocaleDateString('en-US', {
            year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
        });

        const title = article.titleCn || article.title;
        const summary = article.summaryAiCn || article.summaryAi || 'No summary available.';
        const source = article.source || 'Unknown Source';

        articleCol.innerHTML = `
            <div class="card h-100 shadow-sm article-card-hover">
                <div class="card-body">
                    <h5 class="card-title">${title}</h5>
                    <h6 class="card-subtitle mb-2 text-muted">${source} - ${formattedDate}</h6>
                    <p class="card-text">${summary}</p>
                </div>
                <div class="card-footer bg-transparent border-0">
                     <a href="/article/${article.id}" class="btn btn-primary btn-sm">阅读更多</a>
                </div>
            </div>
        `;
        return articleCol;
    }
</script>
</body>
</html>