<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwiftGoal - AI Sports News</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', 'Noto Sans SC', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .user-bar {
            text-align: right;
            padding: 10px 20px;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .user-bar a, .user-bar span {
            margin-left: 15px;
            color: #1a73e8;
            text-decoration: none;
            font-weight: 500;
        }
        .user-bar .logout-form {
            display: inline;
        }
        .user-bar .logout-button {
            background: none;
            border: none;
            color: #1a73e8;
            padding: 0;
            font: inherit;
            cursor: pointer;
            font-weight: 500;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .header h1 {
            font-weight: 700;
            font-size: 2.8em;
            color: #1a73e8;
        }
        .header p {
            font-weight: 300;
            font-size: 1.2em;
            color: #5f6368;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        .article {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            margin-bottom: 25px;
            padding: 20px;
            transition: box-shadow .3s ease-in-out;
        }
        .article:hover {
            box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
        }
        .article h2 {
            margin-top: 0;
            font-size: 1.4em;
        }
        .article h2 a {
            text-decoration: none;
            color: #1a73e8;
        }
        .article-meta {
            font-size: 0.85em;
            color: #5f6368;
            margin-bottom: 15px;
        }
        .article-meta .source {
            font-weight: 700;
        }
        .ai-analysis {
            margin-top: 15px;
            border-top: 1px solid #e8e8e8;
            padding-top: 15px;
        }
        .ai-analysis h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #3c4043;
            font-size: 1.1em;
            font-weight: 700;
        }
        .ai-summary {
            font-style: italic;
            color: #4d5156;
            line-height: 1.6;
        }
        .ai-tags {
            margin-top: 10px;
        }
        .ai-tags strong {
            font-style: normal;
            font-size: 1em;
            color: #3c4043;
            font-weight: 700;
            margin-right: 5px;
        }
        .ai-tags span.tag {
            display: inline-block;
            background-color: #e8f0fe;
            color: #1967d2;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            margin-right: 8px;
            margin-top: 5px;
        }
        .empty-state {
            text-align: center;
            padding: 50px;
            background-color: #fff;
            border-radius: 8px;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            font-size: 0.9em;
            color: #5f6368;
        }
        .search-container {
            max-width: 600px;
            margin: 0 auto 40px;
        }
        .search-container form {
            display: flex;
        }
        .search-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 20px 0 0 20px;
            box-sizing: border-box;
            font-size: 1em;
            outline: none;
        }
        .search-button {
            padding: 12px 20px;
            border: none;
            background-color: #1a73e8;
            color: white;
            border-radius: 0 20px 20px 0;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
        }
        .search-results-header {
            text-align: center;
            margin-bottom: 20px;
            color: #3c4043;
        }
        .recommendations-header {
            text-align: center;
            margin-bottom: 20px;
            color: #1a73e8;
            font-size: 1.8em;
        }
        .article-recommended {
            border-left: 4px solid #1a73e8;
        }
        .section-divider {
            margin-top: 40px;
            margin-bottom: 40px;
            border: 0;
            border-top: 1px solid #ddd;
        }
    </style>
</head>
<body>

<header class="p-3 mb-3 border-bottom bg-dark text-white">
    <div class="container">
        <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
            <a href="/" class="d-flex align-items-center mb-2 mb-lg-0 text-white text-decoration-none me-4">
                <svg class="bi me-2" width="40" height="32" role="img" aria-label="Bootstrap"><use xlink:href="#bootstrap"></use></svg>
                <span class="fs-4">SwiftGoal</span>
            </a>

            <ul class="nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0">
                <li><a href="/" class="nav-link px-2 text-white">Home</a></li>
                <li th:if="${categories != null and not #lists.isEmpty(categories)}" class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle text-white" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Categories
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <li th:each="cat : ${categories}"><a class="dropdown-item" th:href="@{'/category/' + ${cat}}" th:text="${cat}"></a></li>
                    </ul>
                </li>
            </ul>

            <form class="col-12 col-lg-auto mb-3 mb-lg-0 me-lg-3" th:action="@{/search}">
                <input type="search" name="query" class="form-control form-control-dark" placeholder="Search..." aria-label="Search" th:value="${searchQuery}">
            </form>

            <div sec:authorize="isAuthenticated()" class="dropdown text-end">
                <a href="#" class="d-block link-light text-decoration-none dropdown-toggle" id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
                    <img src="https://github.com/mdo.png" alt="mdo" width="32" height="32" class="rounded-circle">
                </a>
                <div class="dropdown-menu dropdown-menu-dark text-small shadow" aria-labelledby="dropdownUser1">
                    <a class="dropdown-item" th:href="@{/profile}">Profile</a>
                    <hr class="dropdown-divider">
                    <form th:action="@{/logout}" method="post" class="d-inline">
                        <button type="submit" class="dropdown-item">Sign out</button>
                    </form>
                </div>
            </div>

            <div sec:authorize="!isAuthenticated()" class="text-end">
                <a th:href="@{/login}" class="btn btn-outline-light me-2">Login</a>
                <a th:href="@{/register}" class="btn btn-warning">Sign-up</a>
            </div>
        </div>
    </div>
</header>

<div class="container-fluid">
    <div class="row">
        <!-- Main content -->
        <main class="col-md-12 ms-sm-auto col-lg-12 px-md-4">
            <div class="jumbotron text-center bg-light p-5 rounded-3 mb-4">
                <h1 class="display-4">Welcome to SwiftGoal</h1>
                <p class="lead text-muted">Your intelligent source for sports news and analysis.</p>
            </div>

            <!-- News Container -->
            <div id="news-container">
                <!-- Recommended Articles -->
                <div sec:authorize="isAuthenticated()" th:if="${recommendedArticles != null and not #lists.isEmpty(recommendedArticles)}" class="mb-5">
                    <h3 class="recommendations-header">为你推荐</h3>
                    <div th:each="article : ${recommendedArticles}" class="article article-recommended">
                        <h2><a th:href="@{/article/{id}(id=${article.id})}" th:text="${article.titleCn != null ? article.titleCn : article.title}" target="_blank">Article Title</a></h2>
                        <div class="article-meta">
                            <span class="source" th:text="${article.source} + ' (英文)'">Source</span> -
                            <span th:text="${#temporals.format(article.publishDate, 'yyyy-MM-dd HH:mm')}">Date</span>
                        </div>
                         <div th:if="${article.summaryAiCn != null or article.keywordsAi != null}" class="ai-analysis">
                            <h4>AI 智能分析</h4>
                            <p th:if="${article.summaryAiCn != null}" class="ai-summary">
                                <strong style="font-style: normal;">AI摘要：</strong>
                                <span th:text="${article.summaryAiCn}">AI-generated summary...</span>
                            </p>
                            <div th:if="${article.keywordsAi != null}" class="ai-tags">
                                <strong>关键词：</strong>
                                <span class="tag" th:each="keyword : ${#strings.arraySplit(article.keywordsAi, ',')}" th:text="${#strings.trim(keyword)}">Keyword</span>
                            </div>
                        </div>
                    </div>
                </div>

                <hr sec:authorize="isAuthenticated()" th:if="${recommendedArticles != null and not #lists.isEmpty(recommendedArticles)}" class="section-divider">

                <!-- Main Article List -->
                <div th:each="article : ${articles}" class="article">
                    <h2><a th:href="@{/article/{id}(id=${article.id})}" th:text="${article.titleCn != null ? article.titleCn : article.title}" target="_blank">Article Title</a></h2>
                    <div class="article-meta">
                        <span class="source" th:text="${article.source} + ' (英文)'">Source</span> -
                        <span th:text="${#temporals.format(article.publishDate, 'yyyy-MM-dd HH:mm')}">Date</span>
                    </div>
                    <div th:if="${article.summaryAiCn != null or article.keywordsAi != null}" class="ai-analysis">
                        <h4>AI 智能分析</h4>
                        <p th:if="${article.summaryAiCn != null}" class="ai-summary">
                            <strong style="font-style: normal;">AI摘要：</strong>
                            <span th:text="${article.summaryAiCn}">AI-generated summary...</span>
                        </p>
                        <div th:if="${article.keywordsAi != null}" class="ai-tags">
                            <strong>关键词：</strong>
                            <span class="tag" th:each="keyword : ${#strings.arraySplit(article.keywordsAi, ',')}" th:text="${#strings.trim(keyword)}">Keyword</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loading" style="display: none; text-align: center; padding: 20px;">
                <p>正在加载更多新闻...</p>
            </div>

        </main>
    </div>
</div>

<footer class="footer mt-auto py-3 bg-light">
    <div class="footer">
        <p>&copy; 2025 SportsLens AI </p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    let currentPage = /*[[${currentPage}]]*/ 0;
    const totalPages = /*[[${totalPages}]]*/ 1;
    let isLoading = false;

    const newsContainer = document.getElementById('news-container');
    const loadingIndicator = document.getElementById('loading');

    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }) + ' ' +
               date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    }

    async function loadMoreArticles() {
        if (isLoading || currentPage >= totalPages - 1) {
            return;
        }

        isLoading = true;
        loadingIndicator.style.display = 'block';
        currentPage++;

        try {
            const response = await fetch(`/api/news?page=${currentPage}&size=50`);
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const page = await response.json();
            const articles = page.content;

            articles.forEach(article => {
                const articleEl = document.createElement('div');
                articleEl.classList.add('article');

                let title = article.titleCn ? article.titleCn : article.title;
                let source = article.source ? article.source + ' (英文)' : '';
                let publishedAt = formatDate(article.publishDate);
                let summary = article.summaryAiCn ? `<p class="ai-summary">${article.summaryAiCn}</p>` : '';
                let keywords = '';
                if (article.keywordsAi) {
                    keywords = `<div class="ai-tags"><strong>AI 标签:</strong> ${article.keywordsAi.split(',').map(k => `<span class="tag">${k}</span>`).join(' ')}</div>`;
                }
                let aiAnalysis = (summary || keywords) ? `<div class="ai-analysis"><h4>AI 智能分析</h4>${summary}${keywords}</div>` : '';

                articleEl.innerHTML = `
                    <h2><a href="/article/${article.id}" target="_blank">${title}</a></h2>
                    <div class="article-meta">
                        <span class="source">${source}</span> -
                        <span>${publishedAt}</span>
                    </div>
                    ${aiAnalysis}
                `;
                newsContainer.appendChild(articleEl);
            });
        } catch (error) {
            console.error('Failed to fetch articles:', error);
            currentPage--; // Rollback page number on error
        } finally {
            isLoading = false;
            loadingIndicator.style.display = 'none';
        }
    }

    window.addEventListener('scroll', () => {
        const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
        if (clientHeight + scrollTop >= scrollHeight - 100) { // 100px buffer
            loadMoreArticles();
        }
    });
    /*]]>*/
</script>
</body>
</html>