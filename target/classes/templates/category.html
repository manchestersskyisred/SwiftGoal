<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${currentCategory} + ' - SwiftGoal'">Category News</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <style>
        body {
            background-color: #f0f2f5;
        }
        .article-card-hover {
            transition: transform .2s ease-in-out, box-shadow .2s ease-in-out;
        }
        .article-card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
        }
    </style>
</head>
<body>

<!-- Unified Navbar -->
<div th:replace="~{index :: navbar}"></div>

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-2">
            <div th:replace="~{index :: sidebar}"></div>
        </div>

        <div class="col-lg-10">
            <main class="container py-4">
                <h2 th:if="${currentCategory}">Category: <span class="text-primary" th:text="${currentCategory}"></span></h2>

                <div id="articles-container" class="row">
                    <!-- Articles will be loaded here by Thymeleaf and JS -->
                    <div th:each="article : ${articlesPage.content}" class="col-lg-12 mb-4">
                        <div class="card h-100 shadow-sm article-card-hover">
                             <div class="card-body">
                                 <h5 class="card-title" th:text="${article.titleCn != null ? article.titleCn : article.title}">Article Title</h5>
                                 <h6 class="card-subtitle mb-2 text-muted" th:text="${article.source} + ' - ' + ${#temporals.format(article.publishDate, 'MMM dd, yyyy HH:mm')}">Source and Date</h6>
                                 <p class="card-text" th:text="${article.summaryAiCn != null ? article.summaryAiCn : article.summaryAi}"></p>
                             </div>
                             <div class="card-footer bg-transparent border-0">
                                  <a th:href="@{/article/{id}(id=${article.id})}" class="btn btn-primary btn-sm">阅读更多</a>
                             </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    let currentPage = 1;
    let totalPages = [[${articlesPage.totalPages}]];
    let isLoading = false;
    const articlesContainer = document.getElementById('articles-container');
    const currentCategory = /*[[${currentCategory}]]*/ 'default'; // Pass thymeleaf variable to JS

    window.addEventListener('scroll', () => {
        if (isLoading || currentPage >= totalPages) return;

        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
            loadMoreArticles();
        }
    });

    async function loadMoreArticles() {
        isLoading = true;
        showLoadingSpinner();

        // Determine the correct API endpoint
        let apiUrl = '';
        if (currentCategory === '为你推荐') {
            apiUrl = `/api/news/recommendations?page=${currentPage}&size=100`;
        } else {
            apiUrl = `/api/news/category/${currentCategory}?page=${currentPage}&size=100`;
        }

        try {
            const response = await fetch(apiUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const page = await response.json();
            const articles = page.content;

            if (articles.length > 0) {
                articles.forEach(article => {
                    const articleElement = createArticleCard(article);
                    articlesContainer.appendChild(articleElement);
                });
                currentPage++;
            }
            
            if (currentPage >= page.totalPages) {
                showEndOfResults();
                totalPages = currentPage; // Prevent further loading
            }
        } catch (error) {
            console.error("Could not load more articles:", error);
        } finally {
            isLoading = false;
            hideLoadingSpinner();
        }
    }

    function showLoadingSpinner() {
        let spinner = document.getElementById('loading-spinner');
        if (!spinner) {
            spinner = document.createElement('div');
            spinner.id = 'loading-spinner';
            spinner.className = 'text-center py-4';
            spinner.innerHTML = `
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>`;
            articlesContainer.parentNode.appendChild(spinner);
        }
        spinner.style.display = 'block';
    }

    function hideLoadingSpinner() {
        const spinner = document.getElementById('loading-spinner');
        if (spinner) {
            spinner.style.display = 'none';
        }
    }

    function showEndOfResults() {
         let endMessage = document.getElementById('end-of-results');
         if(!endMessage) {
             endMessage = document.createElement('div');
             endMessage.id = 'end-of-results';
             endMessage.className = 'text-center text-muted py-4';
             endMessage.textContent = 'You have reached the end of the list.';
             articlesContainer.parentNode.appendChild(endMessage);
         }
    }

    function createArticleCard(article) {
        const articleCol = document.createElement('div');
        articleCol.className = 'col-lg-12 mb-4';

        const formattedDate = new Date(article.publishDate).toLocaleDateString('en-US', {
            year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
        });

        const title = article.titleCn || article.title;
        const summary = article.summaryAiCn || article.summaryAi || 'No summary available.';
        const source = article.source || 'Unknown Source';

        articleCol.innerHTML = `
            <div class="card h-100 shadow-sm article-card-hover">
                <div class="card-body">
                    <h5 class="card-title">${title}</h5>
                    <h6 class="card-subtitle mb-2 text-muted">${source} - ${formattedDate}</h6>
                    <p class="card-text">${summary}</p>
                </div>
                <div class="card-footer bg-transparent border-0">
                     <a href="/article/${article.id}" class="btn btn-primary btn-sm">阅读更多</a>
                </div>
            </div>
        `;
        return articleCol;
    }
    /*]]>*/
</script>
</body>
</html> 